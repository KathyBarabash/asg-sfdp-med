# ASG-SFDP

**ASG-SFDP** is a FastAPI-based data-serving app, created automatically by the **ASG-tool** and, at runtime, dependent on the **asg-runtime** library.

## Features

ASG-SFDP inherits its features from the **asg-runtime** library and supports the following endpoints:

### Service Endpoints

- `/service/stats`
- `/service/settings`
- `/service/origin_cache/clean`
- `/service/response_cache/clean`

### Data Endpoints

These are one or more endpoints under the `/data/` path, generated by the ASG-tool according to the FDP-to-SFDP contract specification.

## Configuration

ASG-SFDP can be configured through environment variables.  
Example settings are provided in the [.env file](./.env), which can be modified to adjust the runtime behavior of the SFDP app.

## Installation and Usage

There are several options to install and run the SFDP.

### Install and run locally from git sources
> tested to work on Windows with `gitbash` and on `WSL2` `ubuntu24`
> these instructions assume you have access to the TEADAL GitLab

To run SFDP locally:

1. Clone the repository and enter the cloned directory.
2. Create and activate a fresh Python 3.12 virtual environment.

Then install dependencies and start the service. Note that one of the requirements referred to in [requirements.txt](./requirements.txt) is pulling `asg-runtime` library sources from git. Check whether you need to modify repo link, e.g., to accomodate your gitconfig or in case the repo was relocated. Note also that for some configuration choices additional packages might have to be installed as explained in [.env file](./.env) file. If these configuration options are selected without installing the required packages, the app will fail to start and report the problem.

To install terequirements:
```sh
pip install -r requirements.txt
```

To run the app locally:
```sh
uvicorn app:app
```

To run the service in development mode:

```sh
pip install -r requirements-dev.txt

fastapi dev
```

### Create local image and run the container 

On a system that supports containerization (e.g., Docker, Podman), you can build and run a local container image:

To build image with the latest asg-runtime code, use [Dockerfile_from_src](./Dockerfile_from_src). 
It pulls from a private GitLab repository of the project and thus requires valid `ssh` configuration. 
You can follow instructions below or, if you know what you are doing, you can change the `Dockerfile` and, posibly also the `requirements.txt` to support `http` access with tokens.

- Make sure you have ssh access to TEADAL's GitLab server

```sh
ssh -T git@gitlab.teadal.ubiwhere.com
```

- Add your keys to active ssh agent (so it can be used ducting docker build)

```sh
eval $(ssh-agent)
ssh-keyscan gitlab.teadal.ubiwhere.com
ssh-add ~/.ssh/<key>  # use your actual private key
```

- Now build the image
```sh
DOCKER_BUILDKIT=1 docker build --ssh default -t <asg-sfdp>:local -f Dockerfile_from_src .
```

Alternatively, it is possible to build the image from the base `asg-runtime` library image using the [Dockerfile_from_img](./Dockerfile_from_img). Note that you might want to change the image tag used before running the build command as follows:
```sh
docker build  -t <asg-sfdp:local -f Dockerfile_from_img  .
```

- Now run the image while providing it the settings 
```sh
docker run -v $(pwd)/.env:/app/.env -it --rm -p 8000:8000 sfdp-med-img:local

# or 

docker run --env-file .env -it --rm -p 8000:8000 <asg-sfdp>:local

# or as separate variables
```

- Now you should be able to access the image (if running locally) at `http://localhost:8000/docs`


#### Notes 
If you are building inside a VM and encounter network issues, try:

```sh
docker build --network=host -t <asg-sfdp>:local .
```

If this does not help, you might need additional infrastructure troubleshooting.  
*(TODO: Add instructions)*

Once the image is created (check with `docker images`), you can run the container:

```sh
docker run -it --rm -p 8000:8000 <asg-sfdp>:local
```

Again, if running inside a VM with networking issues, you can run with host networking:

```sh
docker run --rm -it --network=host <asg-sfdp>:local
```
### Deploying on k8s
TODO

## Accessing the Service

When the SFDP app is running, its endpoints can be accessed either through a web browser or tools like `curl`.

## Directory Structure

```plaintext
.
├── .env                # Example settings
├── Dockerfile_from_img # Defines how to containerize the app
├── Dockerfile_from_src # Defines how to containerize the app
├── app.py              # The main FastAPI application
├── requirements.txt    # Production dependencies
├── requirements-dev.txt# Development-only dependencies
├── transforms/         # Folder containing data transformation functions
├── README.md/          # This file :-)
```

